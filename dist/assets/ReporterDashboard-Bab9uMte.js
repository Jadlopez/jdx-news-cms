var D=t=>{throw TypeError(t)};var z=(t,e,a)=>e.has(t)||D("Cannot "+a);var o=(t,e,a)=>(z(t,e,"read from private field"),a?a.call(t):e.get(t)),k=(t,e,a)=>e.has(t)?D("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,a),M=(t,e,a,r)=>(z(t,e,"write to private field"),r?r.call(t,a):e.set(t,a),a),U=(t,e,a)=>(z(t,e,"access private method"),a);import{S as Y,s as Z,x as G,y as $,h as V,u as W,r as n,n as tt,k as et,m as _,j as s,z as y}from"./index-D7F0MAQ-.js";import{d as st,u as at,b as rt,c as ot,e as it,f as lt}from"./newsService-DiONljKG.js";import{u as nt,a as ct,o as ut,s as L}from"./schemas-TicUotkH.js";import{N as dt}from"./NewsList-CM2royf-.js";var v,O,h,x,E,P,F,q,ht=(q=class extends Y{constructor(e,a){super();k(this,E);k(this,v);k(this,O);k(this,h);k(this,x);M(this,v,e),this.setOptions(a),this.bindMethods(),U(this,E,P).call(this)}bindMethods(){this.mutate=this.mutate.bind(this),this.reset=this.reset.bind(this)}setOptions(e){var r;const a=this.options;this.options=o(this,v).defaultMutationOptions(e),Z(this.options,a)||o(this,v).getMutationCache().notify({type:"observerOptionsUpdated",mutation:o(this,h),observer:this}),a!=null&&a.mutationKey&&this.options.mutationKey&&G(a.mutationKey)!==G(this.options.mutationKey)?this.reset():((r=o(this,h))==null?void 0:r.state.status)==="pending"&&o(this,h).setOptions(this.options)}onUnsubscribe(){var e;this.hasListeners()||(e=o(this,h))==null||e.removeObserver(this)}onMutationUpdate(e){U(this,E,P).call(this),U(this,E,F).call(this,e)}getCurrentResult(){return o(this,O)}reset(){var e;(e=o(this,h))==null||e.removeObserver(this),M(this,h,void 0),U(this,E,P).call(this),U(this,E,F).call(this)}mutate(e,a){var r;return M(this,x,a),(r=o(this,h))==null||r.removeObserver(this),M(this,h,o(this,v).getMutationCache().build(o(this,v),this.options)),o(this,h).addObserver(this),o(this,h).execute(e)}},v=new WeakMap,O=new WeakMap,h=new WeakMap,x=new WeakMap,E=new WeakSet,P=function(){var a;const e=((a=o(this,h))==null?void 0:a.state)??$();M(this,O,{...e,isPending:e.status==="pending",isSuccess:e.status==="success",isError:e.status==="error",isIdle:e.status==="idle",mutate:this.mutate,reset:this.reset})},F=function(e){V.batch(()=>{var a,r,m,j,u,N,w,p;if(o(this,x)&&this.hasListeners()){const i=o(this,O).variables,d=o(this,O).context,b={client:o(this,v),meta:this.options.meta,mutationKey:this.options.mutationKey};(e==null?void 0:e.type)==="success"?((r=(a=o(this,x)).onSuccess)==null||r.call(a,e.data,i,d,b),(j=(m=o(this,x)).onSettled)==null||j.call(m,e.data,null,i,d,b)):(e==null?void 0:e.type)==="error"&&((N=(u=o(this,x)).onError)==null||N.call(u,e.error,i,d,b),(p=(w=o(this,x)).onSettled)==null||p.call(w,void 0,e.error,i,d,b))}this.listeners.forEach(i=>{i(o(this,O))})})},q);function Q(t,e){const a=W(e),[r]=n.useState(()=>new ht(a,t));n.useEffect(()=>{r.setOptions(t)},[r,t]);const m=n.useSyncExternalStore(n.useCallback(u=>r.subscribe(V.batchCalls(u)),[r]),()=>r.getCurrentResult(),()=>r.getCurrentResult()),j=n.useCallback((u,N)=>{r.mutate(u,N).catch(tt)},[r]);if(m.error&&et(r.options.throwOnError,[m.error]))throw m.error;return{...m,mutate:j,mutateAsync:m.mutate}}const mt=ut({title:L().min(1,"El título es obligatorio"),subtitle:L().optional(),content:L().min(1,"El contenido es obligatorio"),category:L().optional(),status:L().optional()});function bt({existing:t=null,onSaved:e=null}){const{user:a,userData:r}=_(),m=W(),j=n.useRef(!0);n.useEffect(()=>()=>{j.current=!1},[]);const{register:u,handleSubmit:N,reset:w,setValue:p,formState:{errors:i,isSubmitting:d}}=nt({resolver:ct(mt),defaultValues:{title:"",subtitle:"",content:"",category:"",status:"Edición"}}),[b,R]=n.useState(null),[S,c]=n.useState(null);n.useEffect(()=>{t?(p("title",t.title??t.titulo??""),p("subtitle",t.subtitle??t.subtitulo??""),p("content",t.content??""),p("category",t.category??t.categoria??""),p("status",t.status??t.estado??"Edición"),c(t.imageUrl??t.imageURL??null)):(w(),R(null),c(null))},[t]),n.useEffect(()=>()=>{S&&S.startsWith("blob:")&&URL.revokeObjectURL(S)},[S]);const I=l=>{var g;const f=((g=l.target.files)==null?void 0:g[0])??null;if(f){if(!f.type.startsWith("image/")){y.error("Selecciona un archivo de imagen válido.");return}if(f.size>5*1024*1024){y.error("La imagen no debe superar 5 MB.");return}R(f),c(URL.createObjectURL(f))}},T=Q(l=>ot(l),{onSuccess:()=>{m.invalidateQueries(["news"]),y.success("Noticia creada correctamente"),typeof e=="function"&&e()},onError:l=>{console.error("createNews error",l),y.error("No se pudo crear la noticia")}}),K=Q(({id:l,payload:f})=>rt(l,f),{onSuccess:()=>{m.invalidateQueries(["news"]),y.success("Noticia actualizada correctamente"),typeof e=="function"&&e()},onError:l=>{console.error("updateNews error",l),y.error("No se pudo actualizar la noticia")}}),H=async l=>{const f={title:l.title,subtitle:l.subtitle??"",content:l.content,category:l.category??"",status:l.status??"Edición",author:(a==null?void 0:a.id)??(a==null?void 0:a.email)??"Anónimo",updatedAt:new Date().toISOString()};let g=(t==null?void 0:t.imageUrl)??(t==null?void 0:t.imageURL)??"",A=(t==null?void 0:t.imagePath)??(t==null?void 0:t.image_path)??"";if(b){if(A)try{await st(A)}catch(X){console.warn("No se pudo borrar la imagen anterior:",X)}const C=await at(b);if(!C||!C.url)throw new Error("Error al subir la imagen");g=C.url,A=C.path??C.fullPath??C.storagePath??""}const B={...f,imageUrl:g,imagePath:A};if(t!=null&&t.id||t!=null&&t.uid){const C=t.id??t.uid;await K.mutateAsync({id:C,payload:B})}else await T.mutateAsync({...B,createdAt:new Date().toISOString()}),w(),R(null),c(null)},J=async l=>{const f=(r==null?void 0:r.role)??null;if(["Publicado","Desactivado"].includes(l.status)&&f!=="editor"){y.error("No tienes permisos para asignar ese estado.");return}const g=y.loading("Guardando noticia...");try{await H(l),y.success("Guardado",{id:g})}catch{y.error("Error al guardar noticia",{id:g})}};return s.jsxs("form",{onSubmit:N(J),className:"space-y-4 bg-white p-4 rounded-2xl shadow-md",children:[s.jsx("h2",{className:"text-lg font-semibold text-jdx-dark",children:t?"Editar Noticia":"Nueva Noticia"}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium mb-1",children:"Título"}),s.jsx("input",{type:"text",className:"w-full p-2 border rounded-lg",...u("title")}),i.title&&s.jsx("p",{className:"text-red-600 text-sm",children:i.title.message})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium mb-1",children:"Bajada / Subtítulo"}),s.jsx("input",{type:"text",className:"w-full p-2 border rounded-lg",...u("subtitle")})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium mb-1",children:"Contenido"}),s.jsx("textarea",{className:"w-full p-2 border rounded-lg h-32",...u("content")}),i.content&&s.jsx("p",{className:"text-red-600 text-sm",children:i.content.message})]}),s.jsxs("div",{children:[s.jsx("label",{className:"block text-sm font-medium mb-1",children:"Imagen"}),s.jsx("input",{type:"file",accept:"image/*",onChange:I}),S&&s.jsx("img",{src:S,alt:"Preview",className:"mt-2 w-40 h-40 object-cover rounded-lg"})]}),s.jsxs("div",{className:"jdx-form-section",children:[s.jsx("label",{className:"jdx-label",children:"Categoría"}),s.jsx("input",{className:"jdx-input",...u("category"),disabled:d}),s.jsx("label",{className:"jdx-label",children:"Estado"}),s.jsxs("select",{className:"jdx-select",...u("status"),disabled:d||(r==null?void 0:r.role)!=="editor",children:[s.jsx("option",{value:"Edición",children:"Edición"}),s.jsx("option",{value:"Terminado",children:"Terminado"}),s.jsx("option",{value:"Publicado",children:"Publicado"}),s.jsx("option",{value:"Desactivado",children:"Desactivado"})]})]}),s.jsxs("div",{className:"jdx-form-actions",children:[s.jsx("button",{type:"submit",className:"jdx-btn-primary",disabled:d,children:d?"Guardando...":t?"Actualizar":"Crear noticia"}),s.jsx("button",{type:"button",className:"jdx-btn-secondary",onClick:()=>{w(),R(null),c((t==null?void 0:t.imageUrl)??null)},disabled:d,children:"Restablecer"})]})]})}function wt(){const{user:t,userData:e}=_(),[a,r]=n.useState([]),[m,j]=n.useState(null),[u,N]=n.useState(!1),[w,p]=n.useState(null),[i,d]=n.useState(!0),b=n.useCallback(async()=>{if(t!=null&&t.id){N(!0),p(null);try{const c=await it(t.id);r(Array.isArray(c)?c:[])}catch(c){console.error("Error cargando noticias:",c),p("Error al cargar tus noticias.")}finally{N(!1)}}},[t]);n.useEffect(()=>{b()},[b]);const R=c=>{j(c),d(!0),window.scrollTo({top:0,behavior:"smooth"})},S=async(c,I)=>{if(window.confirm("¿Eliminar esta noticia? Esta acción no se puede deshacer."))try{await lt(c,I),await b()}catch(K){console.error("Error eliminando noticia:",K),alert("No se pudo eliminar la noticia.")}};return s.jsxs("div",{className:"reporter-dashboard p-6",children:[s.jsxs("header",{className:"mb-4 flex items-center justify-between",children:[s.jsxs("div",{children:[s.jsx("h1",{className:"text-2xl font-semibold text-jdx-dark",children:"Panel de Reportero"}),s.jsxs("p",{className:"text-gray-600 text-sm",children:["Usuario: ",(e==null?void 0:e.email)??(t==null?void 0:t.email)??"—"]})]}),s.jsx("div",{children:s.jsx("button",{className:"jdx-btn jdx-btn-outline",onClick:()=>{d(c=>!c),i||j(null)},"aria-pressed":i,children:i?"Ocultar formulario":"Crear noticia"})})]}),i&&s.jsx(bt,{existing:m,onSaved:()=>{j(null),b()}}),s.jsx("div",{className:"my-4",children:s.jsx("button",{className:"px-3 py-2 bg-gray-700 text-white rounded",onClick:()=>d(!i),children:i?"Ocultar formulario":"Crear noticia"})}),w&&s.jsx("div",{className:"p-3 bg-red-50 text-red-600 border border-red-200 rounded",children:w}),u?s.jsx("p",{children:"Cargando noticias…"}):s.jsx(dt,{news:a,onEdit:R,onDelete:S})]})}export{wt as default};
